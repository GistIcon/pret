(function () {if (KXL && KXL.i18n && KXL.i18n.addLocales) {KXL.i18n.addLocales({"attackBeacon.ribbon.settings.header":"attack beacon settings","attackBeacon.ribbon.settings.checkbox.label":"Show %{groupTitle}","attackBeacon.button.title":"<strong>%{username}</strong> is under attack!","attackBeacon.button.title.self":"<strong>%{username}</strong> is attacking YOU!","attackBeacon.button.location":"SECTOR %{sector}: %{coords}","attackBeacon.button.title.multi":"%{count} Allies are under attack!","attackBeacon.ribbon.alerts.alert.title":"<a class=\"kx-username kx-link\">%{username}</a> is under attack!","attackBeacon.ribbon.alerts.alert.title.self":"<a class=\"kx-username kx-link\">%{username}</a> is attacking YOU!","attackBeacon.ribbon.alerts.alert.sector":"SECTOR %{sector}:","attackBeacon.ribbon.alerts.alert.locationCta.label":"play","attackBeacon.ribbon.noalerts":"There are no attacks happening right now."});}}());

(function () {var head = document.getElementsByTagName("head")[0];var style = document.createElement("style");style.type = "text/css";style.innerHTML = ".kx-banner-region.attackBeaconBanner .kx-divider-horizontal{display:none}.kx-attack-beacon-button{min-width:30px;color:#fff;margin:0 10px;position:relative;cursor:pointer;display:table;height:inherit}.kx-attack-beacon-button .kx-attack-beacon-button-inner{display:table-cell;vertical-align:middle}.kx-attack-beacon-button .kx-attack-beacon-button-inner .kx-attack-beacon-btn{position:relative;height:34px}.kx-attack-beacon-button:hover .kx-icon{background-position:center -57px}.kx-attack-beacon-button .kx-icon{background-position:center -3px;background-repeat:no-repeat;background-image:url(/modules/attack_beacon/images/attack_beacon_btn_sprite.png?1516310828);position:absolute;width:68px;height:47px;top:0;right:-20px}.kx-attack-beacon-button .kx-content{overflow:hidden}.kx-attack-beacon-button.kx-alert-showing .kx-attack-beacon-button-inner .kx-icon{background-position:center -112px}.kx-attack-beacon-button.kx-alert-showing .kx-attack-beacon-button-inner .kx-attack-beacon-btn{width:auto;bottom:5px;padding-left:20px}.kx-attack-beacon-button.kx-alert-showing .kx-attack-beacon-button-inner .kx-attack-beacon-btn>div{height:inherit}.kx-attack-beacon-button.kx-alert-showing .kx-attack-beacon-button-inner .kx-attack-beacon-btn .kx-left-cap,.kx-attack-beacon-button.kx-alert-showing .kx-attack-beacon-button-inner .kx-attack-beacon-btn .kx-right-cap{background-position:0 center;background-repeat:no-repeat;width:20px}.kx-attack-beacon-button.kx-alert-showing .kx-attack-beacon-button-inner .kx-attack-beacon-btn .kx-left-cap{background-image:url(/modules/attack_beacon/images/attack_beacon_btn_left_cap.png?1516310828);position:absolute;left:0;top:0}.kx-attack-beacon-button.kx-alert-showing .kx-attack-beacon-button-inner .kx-attack-beacon-btn .kx-content{text-align:center;background-image:url(/modules/attack_beacon/images/attack_beacon_btn_middle.png?1516310828);background-repeat:repeat-x;float:left;padding-top:12px;overflow:hidden;font-family:proxima-nova,'helvetica neue',helvetica,arial,sans-serif;font-size:13px;line-height:22px;text-transform:uppercase;text-shadow:0 -1px 0 #000;font-weight:600}.kx-attack-beacon-button.kx-alert-showing .kx-attack-beacon-button-inner .kx-attack-beacon-btn .kx-right-cap{background-image:url(/modules/attack_beacon/images/attack_beacon_btn_right_cap.png?1516310828);float:right}.kx-attack-beacon-ribbon{font-family:myriad-pro,verdana,helvetica,sans-serif;font-size:14px;width:100%;height:72px;position:relative;border-bottom:2px solid #7c2626;background-color:#000;background-position:left top;background-repeat:repeat-x;background-image:url(/modules/attack_beacon/images/attack_beacon_ribbon_background.png?1516310828)}.kx-attack-beacon-ribbon .kx-settings-btn-wrapper{float:right;display:table;height:72px;width:20px;padding:0 5px}.kx-attack-beacon-ribbon .kx-settings-btn-wrapper .kx-settings-btn-region{display:table-cell;vertical-align:middle}.kx-attack-beacon-ribbon .kx-settings-btn-wrapper .kx-settings-btn-region .kx-settings-btn{width:20px;height:19px;border:none;background:url(/modules/attack_beacon/images/attack_beacon_settings_cog.png?1516310828) center top}.kx-attack-beacon-ribbon .kx-settings-btn-wrapper .kx-settings-btn-region .kx-settings-btn:hover{background-position:center bottom}.kx-attack-beacon-ribbon .kx-alerts-region{overflow:hidden;min-width:100px;position:relative;text-align:center;height:72px}.kx-attack-beacon-ribbon .kx-alerts-region .kx-alerts{display:inline-block}.kx-attack-beacon-ribbon .kx-alerts-region.kx-scrolling-activated .kx-alerts{position:absolute;top:0;right:0;display:block}.kx-attack-beacon-ribbon .kx-alerts-scroller{position:absolute;top:0;padding-top:11px;padding-right:10px;left:0;bottom:0;width:100px;height:70px;background-repeat:no-repeat;background-image:url(/modules/attack_beacon/images/left_side_fade.png?1516310828);background-position:0 0}.kx-attack-beacon-ribbon .kx-alerts-scroller .kx-alerts-scroller-btn{background-repeat:no-repeat;background-image:url(/modules/attack_beacon/images/attack_beacon_scroller_btns.png?1516310828);width:18px;height:49px;cursor:pointer;float:left}.kx-attack-beacon-ribbon .kx-alerts-scroller .kx-alerts-scroller-btn.kx-alerts-scroller-btn-left{background-position:0 -49px}.kx-attack-beacon-ribbon .kx-alerts-scroller .kx-alerts-scroller-btn.kx-alerts-scroller-btn-left:hover{background-position:0 0}.kx-attack-beacon-ribbon .kx-alerts-scroller .kx-alerts-scroller-btn.kx-alerts-scroller-btn-right{background-position:-18px 0}.kx-attack-beacon-ribbon .kx-alerts-scroller .kx-alerts-scroller-btn.kx-alerts-scroller-btn-right:hover{background-position:-18px -49px}.kx-alerts .kx-alert{float:right;padding-top:11px;padding-right:15px;padding-left:15px}.kx-alerts .kx-no-alerts{line-height:72px}.kx-no-alerts{color:#ccc;font-weight:700}.kx-alert{background-position:left center;background-repeat:no-repeat;background-image:url(/modules/attack_beacon/images/edge.png?1516310828)}.kx-alert .kx-alert-inner{padding:0 5px}.kx-alert .kx-alert-inner .kx-group-icon-wrapper{float:right;position:relative;top:-5px;cursor:pointer}.kx-alert .kx-alert-inner .kx-group-icon-wrapper .kx-group-icon{border:1px solid #333;position:absolute;top:5px;right:6px;height:46px;width:46px}.kx-alert .kx-alert-inner .kx-group-icon-wrapper .kx-group-icon-bg{background-color:#000;opacity:.2;width:58px;height:58px}.kx-alert .kx-alert-inner .kx-content{float:right;padding-right:12px}.kx-alert .kx-alert-inner .kx-content .kx-title{color:#ccc;font-weight:700;padding-bottom:7px}.kx-alert .kx-alert-inner .kx-content .kx-location .kx-location-text{float:left}.kx-alert .kx-alert-inner .kx-content .kx-location .kx-location-text .kx-sector{color:#666}.kx-alert .kx-alert-inner .kx-content .kx-location .kx-location-text .kx-coords{color:#ccc}.kx-alert .kx-alert-inner .kx-content .kx-location .kx-scout-btn-region{float:left;padding-left:25px}.kx-alert .kx-alert-inner .kx-content .kx-location .kx-scout-btn-region .kx-scout-btn{height:18px}.kx-alert .kx-alert-inner .kx-content .kx-location .kx-scout-btn-region .kx-scout-btn:hover .kx-button-left-cap{background-position:center -36px}.kx-alert .kx-alert-inner .kx-content .kx-location .kx-scout-btn-region .kx-scout-btn:hover .kx-button-label{background-position:center bottom}.kx-alert .kx-alert-inner .kx-content .kx-location .kx-scout-btn-region .kx-scout-btn:hover .kx-button-right-cap{background-position:center -54px}.kx-alert .kx-alert-inner .kx-content .kx-location .kx-scout-btn-region .kx-scout-btn .kx-button-left-cap,.kx-alert .kx-alert-inner .kx-content .kx-location .kx-scout-btn-region .kx-scout-btn .kx-button-right-cap{background-repeat:no-repeat;background-image:url(/modules/attack_beacon/images/scout_btn_sprite.png?1516310828);width:8px;height:18px}.kx-alert .kx-alert-inner .kx-content .kx-location .kx-scout-btn-region .kx-scout-btn .kx-button-left-cap{background-position:center 0}.kx-alert .kx-alert-inner .kx-content .kx-location .kx-scout-btn-region .kx-scout-btn .kx-button-right-cap{background-position:center -18px}.kx-alert .kx-alert-inner .kx-content .kx-location .kx-scout-btn-region .kx-scout-btn .kx-button-label{height:18px;min-width:50px;font-family:proxima-nova,'helvetica neue',helvetica,arial,sans-serif;font-size:13px;line-height:18px;text-transform:uppercase;text-shadow:0 -1px 0 #000;font-weight:600;background-repeat:repeat-x;background-image:url(/modules/attack_beacon/images/scout_btn_middle.png?1516310828);background-position:center top}.kx-attack-beacon-settings{text-align:center}.kx-attack-beacon-settings .kx-header-bar{font-weight:400;font-size:16px}.kx-attack-beacon-settings .kx-user-groups-region{overflow-y:auto;max-height:240px;margin-bottom:30px;margin-top:15px}.kx-attack-beacon-settings .kx-user-groups-region .kx-user-groups{display:inline-block}";head.appendChild(style);}());

(function () {this.Templates=this.Templates||{},this.Templates["attack_beacon/attack-beacon-button"]=Handlebars.template(function(a,t,e,n,s){return this.compilerInfo=[4,">= 1.0.0"],e=this.merge(e,a.helpers),s=s||{},'<div class="kx-attack-beacon-button-inner">\n<div class="kx-icon"></div>\n<div class="kx-attack-beacon-btn" style="display: none;">\n<div class="kx-left-cap"></div>\n<div class="kx-content">\n<div class="kx-title"></div>\n<div class="kx-location" style="display: none;"></div>\n<div class="kx-title-hidden"  style="visibility: hidden;"></div>\n<div class="kx-location-hidden" style="visibility: hidden;"></div>\n</div>\n<div class="kx-right-cap"></div>\n</div>\n</div>\n'}),this.Templates["attack_beacon/attack-beacon-ribbon-alert"]=Handlebars.template(function(a,t,e,n,s){this.compilerInfo=[4,">= 1.0.0"],e=this.merge(e,a.helpers),s=s||{};var i,l,c="",r="function",o=this.escapeExpression;return c+='<div class="kx-alert-inner kx-clearfix">\n<div class="kx-group-icon-wrapper">\n<div class="kx-group-icon-bg"></div>\n<img class="kx-group-icon" src="',(l=e.getIconurl)?i=l.call(t,{hash:{},data:s}):(l=t&&t.getIconurl,i=typeof l===r?l.call(t,{hash:{},data:s}):l),c+=o(i)+'"></img>\n</div>\n<div class="kx-content">\n<div class="kx-title">',(l=e.getTitle)?i=l.call(t,{hash:{},data:s}):(l=t&&t.getTitle,i=typeof l===r?l.call(t,{hash:{},data:s}):l),c+=o(i)+'</div>\n<div class="kx-location">\n<div class="kx-location-text">\n<span class="kx-sector">',(l=e.getSectorText)?i=l.call(t,{hash:{},data:s}):(l=t&&t.getSectorText,i=typeof l===r?l.call(t,{hash:{},data:s}):l),c+=o(i)+'</span>\n<span class="kx-coords">'+o((i=t&&t.alert,i=null==i||i===!1?i:i.coords,typeof i===r?i.apply(t):i))+'</span>\n</div>\n<div class="kx-scout-btn-region"></div>\n</div>\n</div>\n</div>\n'}),this.Templates["attack_beacon/attack-beacon-ribbon-empty"]=Handlebars.template(function(a,t,e,n,s){this.compilerInfo=[4,">= 1.0.0"],e=this.merge(e,a.helpers),s=s||{};var i,l,c="",r=e.helperMissing,o=this.escapeExpression;return c+='<div class="kx-alert-inner kx-clearfix">\n'+o((i=e.i18n||t&&t.i18n,l={hash:{},data:s},i?i.call(t,"attackBeacon.ribbon.noalerts",l):r.call(t,"i18n","attackBeacon.ribbon.noalerts",l)))+"\n</div>\n"}),this.Templates["attack_beacon/attack-beacon-ribbon"]=Handlebars.template(function(a,t,e,n,s){return this.compilerInfo=[4,">= 1.0.0"],e=this.merge(e,a.helpers),s=s||{},'<div class="kx-attack-beacon-ribbon-inner kx-clearfix">\n<div class="kx-settings-btn-wrapper">\n<div class="kx-settings-btn-region"></div>\n</div>\n<div class="kx-alerts-region">\n</div>\n<div class="kx-alerts-scroller kx-no-text-selection" style="display: none;">\n<div class="kx-alerts-scroller-btn kx-alerts-scroller-btn-left"></div>\n<div class="kx-alerts-scroller-btn kx-alerts-scroller-btn-right"></div>\n</div>\n</div>\n'}),this.Templates["attack_beacon/attack-beacon-settings-user-group-item"]=Handlebars.template(function(a,t,e,n,s){return this.compilerInfo=[4,">= 1.0.0"],e=this.merge(e,a.helpers),s=s||{},'<div class="kx-attack-beacon-button-inner">\n<div class="kx-attack-beacon-btn">\n</div>\n</div>\n'}),this.Templates["attack_beacon/attack-beacon-settings"]=Handlebars.template(function(a,t,e,n,s){this.compilerInfo=[4,">= 1.0.0"],e=this.merge(e,a.helpers),s=s||{};var i,l,c="",r=e.helperMissing,o=this.escapeExpression;return c+='<div class="kx-header-bar">\n<h2>'+o((i=e.i18n||t&&t.i18n,l={hash:{},data:s},i?i.call(t,"attackBeacon.ribbon.settings.header",l):r.call(t,"i18n","attackBeacon.ribbon.settings.header",l)))+'</h2>\n</div>\n<div class="kx-user-groups-region"></div>\n'});}());

/* kxl-deployment-tools 2018-01-18 */

KXL.module("AttackBeacon",function(a,b,c,d,e,f){function g(a,b){var c=a.get(0);c&&(c.style.removeProperty?c.style.removeProperty(b):c.style.removeAttribute(b))}b.on("initialize:after",function(){var a=[b.config.STATIC_BASE_URL+"/modules/attack_beacon/images/scout_btn_sprite.png",b.config.STATIC_BASE_URL+"/modules/attack_beacon/images/scout_btn_middle.png",b.config.STATIC_BASE_URL+"/modules/attack_beacon/images/attack_beacon_btn_left_cap.png",b.config.STATIC_BASE_URL+"/modules/attack_beacon/images/attack_beacon_btn_middle.png",b.config.STATIC_BASE_URL+"/modules/attack_beacon/images/attack_beacon_btn_right_cap.png",b.config.STATIC_BASE_URL+"/modules/attack_beacon/images/attack_beacon_btn_sprite.png",b.config.STATIC_BASE_URL+"/modules/attack_beacon/images/attack_beacon_scroller_btns.png",b.config.STATIC_BASE_URL+"/modules/attack_beacon/images/attack_beacon_settings_cog.png"];b.Common.Utils.ImageUtils.preload(a)}),a.Button=b.Components.Layout.extend({className:"kx-attack-beacon-button kx-no-text-selection",template:Templates["attack_beacon/attack-beacon-button"],_buttonState:void 0,_pulseTimeline:void 0,_rotateMessagesTimeline:void 0,TITLE_ANIMATION_SPEED:250,triggers:{click:"clicked",mouseenter:"hoverover",mouseleave:"hoverout","click .kx-location":{stopPropagation:!1,event:"location:clicked"}},ui:{contentPane:".kx-content",button:".kx-attack-beacon-btn",title:".kx-title",titleHidden:".kx-title-hidden",location:".kx-location",locationHidden:".kx-location-hidden",leftCap:".kx-left-cap",icon:".kx-icon"},toggleExpanded:function(a){var c=e.Deferred(),d=this,f=this._buttonState.get("expanded");if(void 0===a&&(a=!f),f===a)return c.resolve(),c;f||(d.ui.button.show(),g(this.ui.contentPane,"width"));var h=this.ui.contentPane.outerWidth(),i=b.Common.Utils.Animation.calculateAnimateDuration(h,d.TITLE_ANIMATION_SPEED);return TweenLite.killTweensOf(this.ui.contentPane),TweenLite.killTweensOf(this.ui.leftCap),TweenLite.killTweensOf(this.ui.button),a?TweenLite.fromTo(this.ui.contentPane,i,{css:{width:0}},{css:{width:h},onStart:function(){d.ui.leftCap.css({left:0,width:20}),d.ui.button.css({opacity:1})},onComplete:function(){g(d.ui.contentPane,"width"),d.trigger("width:changed")},onUpdate:function(){d.trigger("width:changed")}}):(TweenLite.fromTo(this.ui.contentPane,i,{css:{width:h}},{css:{width:0},onUpdate:function(){d.trigger("width:changed")},onComplete:function(){d.trigger("width:changed")}}),TweenLite.to(d.ui.leftCap,i,{css:{left:9},onUpdate:function(){d.trigger("width:changed")},onComplete:function(){TweenLite.to(d.ui.button,2,{css:{opacity:0},onComplete:function(){d.ui.button.hide(),d.trigger("width:changed")}}),d.trigger("width:changed")}})),a?TweenLite.fromTo(this.ui.title,i,{opacity:0},{opacity:1,onComplete:function(){c.resolve()}}):TweenLite.fromTo(this.ui.title,i,{opacity:1},{opacity:0,onComplete:function(){c.resolve()}}),this._buttonState.set("expanded",a),c},toggleRotatingMessages:function(a){a?this._rotateMessagesTimeline.restart():(this._rotateMessagesTimeline.pause(),this._rotateMessagesTimeline.seek(0))},toggleHasAlerts:function(a){this.$el.toggleClass("kx-alert-showing",a),this._buttonState.set("hasAlerts",a),a||g(this.ui.icon,"background-position")},togglePulse:function(a){a?this._pulseTimeline.restart():(this._pulseTimeline.pause(),this._pulseTimeline.seek(0))},setAlert:function(a){this._buttonState.set("alert",a),this.model=a},clearAlert:function(){this.model=null,this._buttonState.set("alert",null)},setLocationContent:function(a){this.ui.location.html(a),this.ui.locationHidden.html(a),this.trigger("width:changed")},setTitleContent:function(a){var c=this,d=c.ui.titleHidden.outerWidth(!0);c.ui.titleHidden.css({display:"inline-block"}),c.ui.titleHidden.html(a);var e=c.ui.titleHidden.outerWidth(!0);c.ui.titleHidden.hide(),c.ui.title.width(d),c.ui.title.html(a),c.ui.title.css({position:"relative",left:0}),TweenLite.to(c.ui.title,b.Common.Utils.Animation.calculateAnimateDuration(Math.abs(d-e),c.TITLE_ANIMATION_SPEED),{css:{width:e},onUpdate:function(){c.trigger("width:changed")},onComplete:function(){g(c.ui.title,"position"),g(c.ui.title,"left"),c.ui.titleHidden.css({display:"block"}),g(c.ui.title,"width"),c.trigger("width:changed")}})},showLocation:function(a){var b=this;b.toggleRotatingMessages(!1),b._buttonState.set("currentMessageMode","location"),a?(b.ui.title.hide(),b.ui.location.show()):b.ui.title.fadeOut(500,function(){b.ui.location.fadeIn(500)})},showTitle:function(a){var b=this;b.toggleRotatingMessages(!1),b._buttonState.set("currentMessageMode","title"),a?(b.ui.location.hide(),b.ui.title.show()):b.ui.location.fadeOut(500,function(){b.ui.title.fadeIn(500)})},initialize:function(a){this.options=f.defaults(a,{}),this.options.model||(this.model=new b.Entities.Model),this.options.buttonState||(this._buttonState=new b.Entities.Model({expanded:!1}))},isExpanded:function(){return this._buttonState.get("expanded")},_setupRotatingMessagesTimeLine:function(){var a=this;this._rotateMessagesTimeline?(this._rotateMessagesTimeline.kill(),this._rotateMessagesTimeline.clear()):this._rotateMessagesTimeline=new TimelineMax({delay:0,repeat:-1,repeatDelay:4}),this._rotateMessagesTimeline.to(e(""),5,{css:{opacity:0},onStart:function(){a.ui.title.show(),a.ui.location.hide()}}),this._rotateMessagesTimeline.to(this.ui.title,.5,{css:{opacity:0}}),this._rotateMessagesTimeline.to(this.ui.location,.5,{css:{opacity:1},onStart:function(){a.ui.location.show(),a.ui.title.hide()}}),this._rotateMessagesTimeline.to(e(""),5,{css:{opacity:0}}),this._rotateMessagesTimeline.to(this.ui.location,.5,{css:{opacity:0}}),this._rotateMessagesTimeline.to(this.ui.title,.5,{css:{opacity:1},onStart:function(){a.ui.title.show(),a.ui.location.hide()}})},_setupPulseTimeLine:function(){this._pulseTimeline?(this._pulseTimeline.kill(),this._pulseTimeline.clear()):this._pulseTimeline=new TimelineMax({delay:0,repeat:4,repeatDelay:0}),this._pulseTimeline.to(this.ui.icon,1,{css:{"background-position":"center -166px"}}),this._pulseTimeline.to(this.ui.icon,1,{css:{"background-position":"center -112px"}}),this._pulseTimeline.pause()},onRender:function(){this._setupPulseTimeLine(),this._setupRotatingMessagesTimeLine()}});var h=d.CollectionView.extend({tagName:"ul",className:"kx-user-groups",itemView:b.Components.CheckBox.View,buildItemView:function(a){var c=a.get("settings"),d=new b.Components.CheckBox.View({label:b.i18n.t("attackBeacon.ribbon.settings.checkbox.label",{groupTitle:a.get("group").get("title")}),tagName:"li",model:c,modelAttr:"muteAttackBeacon",getCheckedValueFromModel:function(){return!c.get("muteAttackBeacon")},getModelValueFromChecked:function(){return!d.getValue()}});return d.listenTo(d,"change",function(){var a=b.currentUserGroups.get(c.groupId);a.save({settings:c})}),d}}),i=b.Components.Layout.extend({className:"kx-alert",tagName:"li",template:Templates["attack_beacon/attack-beacon-ribbon-alert"],regions:{scoutBtnRegion:".kx-scout-btn-region"},modelEvents:function(){var a=this;return events={},namespace=this.collection.collection.namespace,events["selected:"+namespace]=function(){a.$el.toggleClass("kx-selected",!0)},events["deselected:"+namespace]=function(){a.$el.toggleClass("kx-selected",!1)},events},ui:{usernameLink:".kx-username",groupIcon:".kx-group-icon"},initialize:function(a){this.options=f.defaults(a,{})},templateHelpers:{getTitle:function(){return this.alert?new Handlebars.SafeString(this.alert.userId===b.currentUser.id?b.i18n.t("attackBeacon.ribbon.alerts.alert.title.self",{username:Handlebars.Utils.escapeExpression(this.alert.attackerAlias)}):b.i18n.t("attackBeacon.ribbon.alerts.alert.title",{username:Handlebars.Utils.escapeExpression(this.alert.alias)})):""},getSectorText:function(){return this.alert?b.i18n.t("attackBeacon.ribbon.alerts.alert.sector",{sector:this.alert.sector}):""},getIconurl:function(){var a=this.group&&this.group.logo&&this.group.logo.small;return a||b.Group.Helpers.getDefaultLogoIconForGroup(this.group)}},serializeData:function(){return{alert:this.model.toJSON(),group:this.options.group&&this.options.group.toJSON?this.options.group.toJSON():null}},onRender:function(){var a=this,c=b.request("attack:beacon:get:game:for:usergroup",a.model.get("groupId")),d=new b.Components.KXLButton.View({customClass:"kx-scout-btn",label:b.i18n.t("attackBeacon.ribbon.alerts.alert.locationCta.label")});a.$el.toggleClass("kx-selected",a.collection.collection.selected===a.model),a.listenTo(d,"click",function(){a.options.vent.trigger("attack:beacon:alert:scout:clicked",a.model),a.trigger("scout:clicked",a.model),b.execute("analytics:track:page:view",f.template("/scout/ribbon/<%= gameUrlName %>/<%= currentUserId %>/<%= targetUserId %>/click",{currentUserId:b.currentUser.id,targetUserId:a.model.get("userId"),gameUrlName:c&&c.get("urlName")}))}),a.scoutBtnRegion.show(d),a.ui.groupIcon.on("click",function(){b.execute("group:show",a.model.get("groupId"))}),a.ui.usernameLink.on("click",function(){b.execute("profile:show",a.model.get("attackerId"))}),b.execute("analytics:track:page:view",f.template("/scout/ribbon/<%= gameUrlName %>/<%= currentUserId %>/<%= targetUserId %>/view",{currentUserId:b.currentUser.id,targetUserId:a.model.get("userId"),gameUrlName:c&&c.get("urlName")}))},onClose:function(){this.ui.usernameLink.off("click"),this.ui.groupIcon.off("click")}}),j=b.Components.Layout.extend({className:"kx-no-alerts",tagName:"li",template:Templates["attack_beacon/attack-beacon-ribbon-empty"]}),k=d.CollectionView.extend({className:"kx-alerts kx-clearfix",tagName:"ul",itemView:i,emptyView:j,itemViewOptions:function(a){var c=a.get("groupId"),d=b.currentUserGroups.get(c),e=d&&d.get("group");return{vent:this.options.vent,model:a,collection:this.collection,group:e||{},game:b.request("attack:beacon:get:game:for:usergroup",a.get("groupId"))||{}}},collectionEvents:{"filter-complete":"render"},appendHtml:function(a,b,c){var d;return 0===c?a.$el.prepend(b.el):(d=a.$el.children().eq(c),d.length?d.before(b.el):a.$el.append(b.el))}});a.SettingsView=b.Components.Layout.extend({className:"kx-attack-beacon-settings kx-clearfix",template:Templates["attack_beacon/attack-beacon-settings"],regions:{userGroupsRegion:".kx-user-groups-region"},onRender:function(){var a=this;a.userGroupsRegion.show(new h({collection:b.request("attack:beacon:get:current:user:custom:groups")}))}}),a.Ribbon=b.Components.Layout.extend({alertsCollection:void 0,vent:void 0,className:"kx-attack-beacon-ribbon",template:Templates["attack_beacon/attack-beacon-ribbon"],regions:{alertsRegion:".kx-alerts-region",settingsBtnRegion:".kx-settings-btn-region"},ui:{leftScrollBtn:".kx-alerts-scroller-btn-left",rightScrollBtn:".kx-alerts-scroller-btn-right",scrollButtonContainer:".kx-alerts-scroller"},initialize:function(a){this.options=f.defaults(a,{alertsCollection:void 0}),this.alertsCollection=this.options.alertsCollection,this.vent=this.options.vent,this.alertsSingleSelect=f.extend(this.alertsCollection.collection,new c.PickThis.SingleSelect(this.alertsCollection.collection,f.uniqueId("attack:beacon:alerts")))},onRender:function(){var c=this,h=new b.Components.Button.View({customClass:"kx-settings-btn"});h.listenTo(h,"click",function(){b.request("show:default:dialog",new a.SettingsView,{size:b.Components.Dialog.SIZES.small})}),c.settingsBtnRegion.show(h);var i=new k({collection:c.alertsCollection,vent:c.vent});c.alertsRegion.show(i);var j=d.Controller.extend({DEFAULT_SCROLL_SPEED:1100,$scrollContainer:void 0,$scrollPane:void 0,$leftScrollerButton:void 0,$rightScrollerButton:void 0,$scrollerButtonContainer:void 0,collectionView:void 0,collection:void 0,timeoutId:void 0,initialize:function(a){function c(){d.$scrollPane.css({opacity:0}),TweenLite.to(d.$scrollPane,.5,{delay:.5,css:{opacity:1}});var a="resize.scroller."+d.collectionView.cid;e(window).on(a,d.checkScrolling.bind(d)),d.collectionView.listenTo(d.collectionView,"close",function(){e(window).off(a)}),setTimeout(function(){d.moveToSelected(!0),d.checkScrolling(),d.resizeCollectionViewEl()},0),d.listenTo(d.collection,"add",function(a){d.timeoutId=setTimeout(function(){d.singleSelectCollection.selected&&d.collection.indexOf(a)<=0&&d.singleSelectCollection.select(a),d.moveToSelected(),d.checkScrolling(),d.resizeCollectionViewEl()},0)}),d.listenTo(d.collection,"remove",function(a){d.timeoutId=setTimeout(function(){if(!d.singleSelectCollection.selected){var c=b.Common.Utils.Collection.next(d.collection,a,!0);c&&d.singleSelectCollection.select(c)}d.moveToSelected(),d.checkScrolling(),d.resizeCollectionViewEl()},0)})}var d=this,g=d.options=f.defaults(a,{SCROLL_SPEED:d.DEFAULT_SCROLL_SPEED});d.SCROLL_SPEED=d.options.SCROLL_SPEED,d.$scrollContainer=g.$scrollContainer,d.$scrollPane=g.collectionView.$el,d.collectionView=g.collectionView,d.collection=d.collectionView.collection,d.singleSelectCollection=d.collectionView.collection.collection,d.$scrollerButtonContainer=g.$scrollerButtonContainer,d.$leftScrollerButton=g.$leftScrollerButton,d.$rightScrollerButton=g.$rightScrollerButton,d.move=f.debounce(d.move.bind(d),200,{trailing:!0}),d.checkScrolling=f.debounce(d.checkScrolling.bind(d),400,{trailing:!0}),d.collectionView.isClosed?d.listenTo(d.collectionView,"render",function(){c()}):c()},resizeCollectionViewEl:function(){0===this.collection.size()?g(this.collectionView.$el,"width"):this.collectionView.$el.width(this.getItemsWidth()+1)},getScrollPaneRightOffset:function(){return this.$scrollContainer.outerWidth()-(this.$scrollPane.offset().left+this.$scrollPane.outerWidth())},getItemsWidth:function(a){var b,c=a||0,d=this,e=0;for(this.collection.size();c<=this.collection.size()-1&&c>-1&&this.collection.size()>0;)b=d.collectionView.children.findByModel(d.collection.at(c)),b&&(e+=b.$el.outerWidth(),c++);return e},shouldShowScrollbars:function(){return this.$scrollContainer.outerWidth()<this.getItemsWidth()},canScroll:function(){var a=this.singleSelectCollection.selected,b=this.collection.indexOf(a);return this.$scrollContainer.outerWidth()<this.getItemsWidth(b)},checkScrolling:function(){this.shouldShowScrollbars()?(this.$scrollContainer.toggleClass("kx-scrolling-activated",!0),this.$scrollerButtonContainer.show()):(this.$scrollContainer.toggleClass("kx-scrolling-activated",!1),this.$scrollerButtonContainer.hide())},move:function(a,c){var d=this,e=this.getScrollPaneRightOffset(),f=b.Common.Utils.Animation.calculateAnimateDuration(Math.abs(a-e),d.options.SCROLL_SPEED);c?d.$scrollPane.css({right:a}):TweenLite.to(d.$scrollPane,f,{css:{right:a}})},scrollRight:function(){this.singleSelectCollection.select(b.Common.Utils.Collection.prev(this.collection,this.singleSelectCollection.selected)),this.moveToSelected()},scrollLeft:function(){this.canScroll()&&(this.singleSelectCollection.select(b.Common.Utils.Collection.next(this.collection,this.singleSelectCollection.selected)),this.moveToSelected())},moveToSelected:function(a){var c=this,d=c.singleSelectCollection.selected;(!d||d&&-1===c.collection.indexOf(d))&&(d=b.Common.Utils.Collection.next(c.collection,d,!0),d&&c.singleSelectCollection.select(d));for(var e,f=0,g=0;g<=this.collection.size()-1&&g>-1&&this.collection.size()>0&&c.collection.at(g)!==d;)e=c.collectionView.children.findByModel(c.collection.at(g)),f+=e.$el.outerWidth(),g++;this.move(-f,a)},onClose:function(){this.timeoutId&&clearTimeout(this.timeoutId)}}),l=this.scroller=new j({$scrollContainer:c.alertsRegion.$el,collectionView:i,$leftScrollerButton:c.ui.leftScrollBtn,$rightScrollerButton:c.ui.rightScrollBtn,$scrollerButtonContainer:c.ui.scrollButtonContainer});c.ui.leftScrollBtn.on("click",function(){l.scrollLeft()}),c.ui.rightScrollBtn.on("click",function(){l.scrollRight()})},onClose:function(){this.scroller.close(),this.ui.leftScrollBtn.off("click"),this.ui.rightScrollBtn.off("click")}})}),KXL.module("AttackBeacon",function(a,b,c,d,e,f){var g=new b.Entities.Model({isAttackBeaconRibbonOpen:!1}),h="attackBeaconBanner";a.AttackBeaconController=d.Controller.extend({vent:void 0,attackBeaconBtnRegion:void 0,attackBeaconBtn:void 0,alertsCollection:void 0,filteredAlertsCollection:void 0,_SHOW_LATEST_ALERT_DURATION:1e4,_EXPAND_ATTACKBEACON_BUTTON_DURATION:1e4,delayedButtonUpdateTimerId:void 0,autoCollapseButtonTimerId:void 0,autoExpandOnFirstLoadTimerId:void 0,_stopAutoExpandOnFirstLoad:function(){this.autoExpandOnFirstLoadTimerId&&(clearTimeout(this.autoExpandOnFirstLoadTimerId),this.autoExpandOnFirstLoadTimerId=null)},_toggleAttackBeaconRibbon:function(a){g.set("isAttackBeaconRibbonOpen",a)},_startAutoExpandOnFirstLoad:function(){var a=this;a._stopAutoExpandOnFirstLoad(),a.autoExpandOnFirstLoadTimerId=setTimeout(function(){a._stopAutoExpandOnFirstLoad(),a.filteredAlertsCollection.size()&&!a.attackBeaconBtn.isExpanded()&&(a.attackBeaconBtn.toggleExpanded(!0),a.attackBeaconBtn.toggleRotatingMessages(1===a.filteredAlertsCollection.size()),a._startAutoCollapseButton())},1e3)},_stopAutoCollapseButton:function(){this.autoCollapseButtonTimerId&&(clearTimeout(this.autoCollapseButtonTimerId),this.autoCollapseButtonTimerId=null)},_stopDelayedButtonUpdate:function(){this.delayedButtonUpdateTimerId&&(clearTimeout(this.delayedButtonUpdateTimerId),this.delayedButtonUpdateTimerId=null)},_startDelayedButtonUpdate:function(){var a=this;a._stopDelayedButtonUpdate(),a.delayedButtonUpdateTimerId=setTimeout(function(){a._updateAttackBeacon(),a.delayedButtonUpdateTimerId=null},a._SHOW_LATEST_ALERT_DURATION)},_startAutoCollapseButton:function(){var a=this;a._stopAutoExpandOnFirstLoad(),a._stopAutoCollapseButton(),a.autoCollapseButtonTimerId=setTimeout(function(){a.attackBeaconBtn.toggleExpanded(!1).done(function(){a._updateAttackBeacon(),a.attackBeaconBtn.toggleRotatingMessages(!1)})},a._EXPAND_ATTACKBEACON_BUTTON_DURATION)},_updateAttackBeaconAlignment:function(){this.attackBeaconBtnRegion.ensureEl(),this.attackBeaconBtnRegion.$el.css({left:-this.attackBeaconBtnRegion.$el.outerWidth(!0)})},_updateAttackBeacon:function(a){var c=this,d=c.filteredAlertsCollection,e=c.attackBeaconBtn,f=d.size();a||1===f?(a=a||d.first(),e.setTitleContent(a.get("userId")===b.currentUser.id?b.i18n.t("attackBeacon.button.title.self",{username:a.get("attackerAlias")}):b.i18n.t("attackBeacon.button.title",{username:a.get("alias")})),e.setLocationContent(b.i18n.t("attackBeacon.button.location",{sector:a.get("sector"),coords:a.get("coords")})),e.toggleHasAlerts(!0),e.setAlert(a)):0===f?(e.togglePulse(!1),e.toggleHasAlerts(!1),e.setTitleContent(""),e.setLocationContent(""),e.clearAlert(),e.toggleRotatingMessages(!1)):(e.setTitleContent(b.i18n.t("attackBeacon.button.title.multi",{count:f})),e.toggleHasAlerts(!0),e.showTitle(!0),e.setLocationContent(""),e.setAlert(null),e.toggleRotatingMessages(!1)),c._updateAttackBeaconAlignment()},_renderAttackBeacon:function(){function c(a){var c=b.request("attack:beacon:get:game:for:usergroup",a),d=c&&c.get("urlName");d&&b.execute("game:play:load",d)}function d(){0===l.size()?(g.get("isAttackBeaconRibbonOpen")&&j._toggleAttackBeaconRibbon(!1),e.toggleExpanded(!1).done(function(){j._updateAttackBeacon(),e.toggleRotatingMessages(!1)})):j._updateAttackBeacon()}var e,i,j=this,k=j.alertsCollection,l=j.filteredAlertsCollection;e=j.attackBeaconBtn=new a.Button,e.listenTo(e,"show",function(){j._updateAttackBeacon(),l.size()&&(j._startAutoExpandOnFirstLoad(),e.togglePulse(!0)),b.execute("analytics:track:page:view","/beacon/topnav/warcommander/view")}),e.listenTo(e,"hoverover",function(){0===l.size()||e.isExpanded()||(e.toggleExpanded(!0),e.toggleRotatingMessages(1===l.size()),j._updateAttackBeacon())}),e.listenTo(e,"location:clicked",function(a){c(a.model.get("groupId"))}),e.listenTo(e,"width:changed",function(){j._updateAttackBeaconAlignment()}),e.listenTo(e,"hoverout",function(){j._stopAutoCollapseButton(),0!==l.size()&&e.isExpanded()&&j._startAutoCollapseButton()}),j.listenTo(b.vent,"banner:hidden",function(a){a.bannerId===h&&(j._toggleAttackBeaconRibbon(!1),e.toggleRotatingMessages(!1))}),e.listenTo(e,"clicked",f.debounce(function(a){var c=this,d=!g.get("isAttackBeaconRibbonOpen");d&&b.execute("analytics:track:page:view","/beacon/topnav/warcommander/click"),c._toggleAttackBeaconRibbon(d),a.model&&(e.showLocation(),e.toggleRotatingMessages(!1))}.bind(j),200)),j.attackBeaconBtnRegion.ensureEl(),j.attackBeaconBtnRegion.$el.hide(),j.attackBeaconBtnRegion.show(e),j.attackBeaconBtnRegion.$el.fadeIn(500),i=new a.Ribbon({alertsCollection:l,vent:this.vent}),j.listenTo(this.vent,"attack:beacon:alert:scout:clicked",function(a){j._stopAutoCollapseButton(),e.toggleRotatingMessages(!1),j._updateAttackBeacon(a),c(a.get("groupId")),j._toggleAttackBeaconRibbon(!1),e.showLocation(!0),e.toggleExpanded(!0)}),j.listenTo(l,"add",function(a){e.isExpanded()?(j._updateAttackBeacon(a),j._startAutoCollapseButton(),e.toggleRotatingMessages(!0),j._startDelayedButtonUpdate()):j._updateAttackBeacon(),e.togglePulse(!0)}),j.listenTo(k,"remove",d),j.listenTo(l,"filter-complete",d),j.listenTo(g,"change:isAttackBeaconRibbonOpen",function(){var a=g.get("isAttackBeaconRibbonOpen");a?b.request("banner:create",{bannerId:h,view:i,animate:!0}):b.request("banner:hide",h,!0)})},initialize:function(a){function d(a){function c(){h.setFilter(void 0,{silent:!1})}var d=a.get("group"),e=d&&d.get("gameId"),f=e&&b.currentUserGames.get(e);f&&!l[e]&&(j.listenTo(f,"change:sector",c),l[e]=c)}function e(a){function b(){h.setFilter(void 0,{silent:!1})}var c=a.get("settings");c&&(j.listenTo(c,"change:muteAttackBeacon",b),k[a.get("groupId")]=b)}{var g,h,i,j=this,k={},l={},m=f.defaults(a,{attackBeaconBtnRegion:void 0});j.vent=new c.Wreqr.EventAggregator}j.attackBeaconBtnRegion=m.attackBeaconBtnRegion,g=j.alertsCollection=m.alertsCollection,i=b.request("attack:beacon:get:current:user:custom:groups"),g.comparator=function(a,b){function c(a){var b=a.get("groupId"),c=i.findWhere({groupId:b}),d=c&&c.get("group"),e=d&&d.get("members");return e&&e.size()||0}var d=a.get("startedAt"),e=b.get("startedAt"),f=a.get("userId"),g=b.get("userId");return f===g?0:d===e?(aSize=c(a),bSize=c(b),aSize>bSize?-1:bSize>aSize?1:0):d>e?-1:1},h=j.filteredAlertsCollection=new c.FilteredCollection(null,{collection:j.alertsCollection}),j.filteredAlertsCollection.setFilter(function(a,c,d){if(a){var e=a.get("groupId"),g=i.findWhere({groupId:e});if(!g)return!1;var h=g.get("group"),j=h&&h.get("gameId"),k=j&&b.currentUserGames.get(j);if(k&&k.get("sector")!==a.get("sector"))return!1;var l=g.get("settings");return l?l.get("muteAttackBeacon")===!0?!1:f.find(d,function(b){return b.get("userId")===a.get("userId")})?!1:!0:!0}}),i.each(function(a){var b=a.get("group"),c=b.get("attackBeacons");c&&g.add(c.models),j.listenTo(c,"add",function(a){g.add(a)}),j.listenTo(c,"remove",function(a){g.remove(a)})}),j.listenTo(i,"remove",function(a){var c=a.get("groupId"),d=k[c];d&&(j.stopListening(a.get("settings"),"change:muteAttackBeacon",d),delete k[c]);var e=a.get("group"),h=e.get("gameId"),m=b.currentUserGames.get(h),n=h&&l[h];if(m&&n){var o=i.filter(function(a){var b=a.get("group"),c=b.get("gameId");return c===h});0===o.length&&(j.stopListening(m,"change:sector",n),delete l[h])}var p=g.where({groupId:a.id});f.each(p,function(a){g.remove(a)})}),i.each(function(a){e(a),d(a)}),j.listenTo(i,"add",function(a){e(a),d(a)}),j._renderAttackBeacon()},onClose:function(){var a=this;a.attackBeaconBtnRegion.ensureEl(),a.attackBeaconBtnRegion.$el.fadeOut(500,function(){a.attackBeaconBtnRegion.close()}),a._stopAutoCollapseButton(),a._stopDelayedButtonUpdate(),a._stopAutoExpandOnFirstLoad(),a._toggleAttackBeaconRibbon(!1),b.request("banner:hide",h,!0)}})}),KXL.module("AttackBeacon",function(a,b,c,d,e,f){function g(){var a=h();if(a.size()){var c=a.at(f.random(0,a.size()-1)),d=c.get("group"),e=d.get("title");return new b.Group.Entities.AttackBeacon({attackId:f.uniqueId(),startedAt:b.Common.Utils.DateUtils.now(),groupId:d.id,userId:f.uniqueId(),alias:f.uniqueId(e+"Attacked"),attackerId:f.uniqueId(),attackerAlias:f.uniqueId(e+"Attacker"),sector:f.random(65,100),coords:12.666})}}function h(){return new c.FilteredCollection(null,{collection:b.currentUserGroups,collectionFilter:function(a){return"custom"===a.get("group").get("type")}})}function i(){var a=new b.Group.Entities.AttackBeacons;return h().each(function(){a.add(g())}),a}function j(){return b.currentUserGames&&b.games&&b.currentUserGames.find(function(a){var c=b.games.get(a.id);return c&&-1!==l.indexOf(c.get("urlName"))})}function k(a){var c=b.currentUserGroups&&b.currentUserGroups.get(a),d=c&&c.get("group");return d&&b.games.get(d.get("gameId"))}{var l=["warcommander"];new(d.Controller.extend({attackBeaconController:void 0,attackBeaconConfig:void 0,alertsCollection:void 0,initialize:function(){var a=this;a.alertsCollection=new b.Group.Entities.AttackBeacons,b.currentUser?a.addCurrentUserListeners():a.listenTo(b.vent,"auth:changed",function(){b.currentUser&&a.addCurrentUserListeners()}),b.reqres.setHandlers({"attack:beacon:setup":a.configureAttackBeacon.bind(a),"attack:beacon:get:game:for:usergroup":k,"attack:beacon:add:fake:alert":function(){a.alertsCollection&&a.alertsCollection.add(g())},"attack:beacon:remove:fake:alert":function(){var b=a.alertsCollection,c=b.size()&&b.at(f.random(0,b.size()-1));c&&b.remove(c)},"attack:beacon:add:fake:alerts":function(){a.alertsCollection&&a.alertsCollection.add(i().models)},"attack:beacon:get:attack:beacon:alerts":function(){return a.attackBeaconController&&a.attackBeaconController.filteredAlertsCollection?a.attackBeaconController.filteredAlertsCollection:void 0},"attack:beacon:get:current:user:custom:groups":function(){return h()}})},configureAttackBeacon:function(a){this.attackBeaconConfig=a,this.checkForSetup()},checkForSetup:function(){var a=this,c=b.request("current:user:settings:entity");b.switches.AttackBeaconEnabled&&b.currentUser&&b.currentUserGames&&b.currentUserGames.size()&&j()?b.appModel.set("attackBeaconEnabled",!0):b.appModel.set("attackBeaconEnabled",!1),b.switches.AttackBeaconEnabled&&b.currentUser&&c&&!c.get("muteGroupAttackBeacons")&&b.currentUserGames&&b.currentUserGames.size()&&j()&&h().size()?b.fetchingCurrentUserGroups.done(function(){a.setupAttackBeacon()}):a.shutDownAttackBeacon()},shutDownAttackBeacon:function(){this.attackBeaconController&&(this.attackBeaconController.close(),this.attackBeaconController=null,b.appModel.set("attackBeaconShowing",!1))},setupAttackBeacon:function(){this.attackBeaconController||(this.attackBeaconController=new a.AttackBeaconController(f.defaults({},this.attackBeaconConfig,{alertsCollection:this.alertsCollection})),b.appModel.set("attackBeaconShowing",!0))},addCurrentUserListeners:function(){var a=this,c=b.request("current:user:settings:entity");a.listenTo(c,"change:muteGroupAttackBeacons",function(){a.checkForSetup()}),a.listenTo(h(),"add remove",function(){a.checkForSetup()}),this.listenTo(b.currentUserGames,"add",function(c){var c=b.games.get(c.get("gameId")),d=c&&-1!==l.indexOf(c.get("urlName"));d&&a.checkForSetup()})}}))}});
//# sourceMappingURL=attack_beacon.min.js.map